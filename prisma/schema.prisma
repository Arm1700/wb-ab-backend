// prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm, pgcrypto]
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id                      String         @id @default(dbgenerated("gen_random_uuid()"))
  email                   String         @unique
  password                String
  role                    UserRole       @default(USER)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  refreshTokens           RefreshToken[]
  wbPartnerToken          String?
  wbPartnerTokenUpdatedAt DateTime?
  products                Product[]
  wbAdverts               WbAdvert[]    // связь с WbAdvert
  abTestSessions          AbTestSession[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("refresh_tokens")
}

model Product {
  id           String    @id @default(dbgenerated("gen_random_uuid()"))
  nmId         BigInt
  name         String?
  brand        String?
  categoryId   Int?
  vendorCode   String?
  subjectName  String?
  description  String?
  video        String?
  wbCreatedAt  DateTime?
  wbUpdatedAt  DateTime?
  syncedAt     DateTime?
  syncStatus   String?
  width        Int?
  height       Int?
  length       Int?
  weightBrutto Float?
  dimsIsValid  Boolean?
  rawCard      Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  userId       String?
  user         User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  metrics         ProductMetric[]
  images          ProductImage[]
  imageHistory    ProductImageHistory[]
  skus            ProductSku[]
  characteristics ProductCharacteristic[]
  abAdTests       AbAdTest[]

  @@unique([userId, nmId], name: "user_nm")
  @@index([userId])
}

model ProductMetric {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  productId   String
  date        DateTime
  impressions Int      @default(0)
  clicks      Int      @default(0)
  orders      Int      @default(0)
  revenue     Decimal? @db.Decimal(12, 2)
  openCount   Int      @default(0)
  cartCount   Int      @default(0)
  buyoutCount Int      @default(0)
  buyoutSum   Decimal? @db.Decimal(12, 2)
  createdAt   DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, date], name: "productId_date")
  @@index([productId, date])
}

model ProductImage {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  productId String
  url       String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductImageHistory {
  id              String   @id @default(dbgenerated("gen_random_uuid()"))
  productId       String
  previousUrl     String
  newUrl          String
  changedAt       DateTime @default(now())
  changedByUserId String?
  reason          String?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId, changedAt])
}

model ProductSku {
  id        String  @id @default(dbgenerated("gen_random_uuid()"))
  productId String
  chrtID    BigInt
  techSize  String?
  wbSize    String?
  sku       String?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, chrtID], name: "productId_chrtID")
}

model ProductCharacteristic {
  id        String  @id @default(dbgenerated("gen_random_uuid()"))
  productId String
  charId    Int?
  name      String?
  value     Json?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
}

model AbAdTest {
  id        String   @id @default(dbgenerated("gen_random_uuid()"))
  productId String?
  name      String
  status    String   @default("draft")
  budget    Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product  Product?      @relation(fields: [productId], references: [id], onDelete: SetNull)
  variants AbAdVariant[]

  @@index([productId])
}

model AbAdVariant {
  id           String   @id @default(dbgenerated("gen_random_uuid()"))
  abAdTestId   String
  variantName  String
  nmIds        Json
  wbCampaignId Int?
  dailyBudget  Int?
  bidType      String   @default("manual")
  placementTypes Json?
  status       String   @default("draft")
  createdAt    DateTime @default(now())

  test  AbAdTest    @relation(fields: [abAdTestId], references: [id], onDelete: Cascade)
  stats AbAdStats[]

  @@index([abAdTestId])
  @@index([wbCampaignId])
}

model AbAdStats {
  id            String   @id @default(dbgenerated("gen_random_uuid()"))
  abAdVariantId String
  date          DateTime
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  ctr           Float    @default(0)
  conversions   Int      @default(0)
  spend         Float    @default(0)
  createdAt     DateTime @default(now())

  variant AbAdVariant @relation(fields: [abAdVariantId], references: [id], onDelete: Cascade)

  @@unique([abAdVariantId, date], name: "variant_date")
  @@index([abAdVariantId, date])
}

model WbAdvert {
  id         Int      @id
  type       Int
  status     Int
  changeTime DateTime?
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId, type, status])
  @@map("wb_adverts")
}

model WbCampaignStats {
  id          String   @id @default(dbgenerated("gen_random_uuid()"))
  userId      String
  campaignId  Int
  date        DateTime @db.Date
  impressions Int      @default(0)
  clicks      Int      @default(0)
  ctr         Float    @default(0)
  conversions Int      @default(0)
  spend       Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, campaignId, date], name: "user_campaign_date")
  @@index([userId, campaignId, date])
  @@map("wb_campaign_stats")
}

model AbTestSession {
  id             Int                 @id @default(autoincrement())
  userId         String
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaignId     BigInt
  nmId           BigInt
  photoUrls      String[]
  viewsPerStep   Int                 @default(1000)
  totalViews     BigInt              @default(0)
  currentStep    Int                 @default(0)
  status         String              @default("running") // running, paused, completed, stopped
  autoTopUp      Boolean             @default(false)
  topUpThreshold Int                 @default(1000)
  topUpAmount    Int                 @default(5000)
  startedAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  lastCheckAt    DateTime?
  nextCheckAt    DateTime?
  imageStats     AbTestImageStats[]

  @@index([campaignId])
  @@index([status])
  @@index([status, nextCheckAt])
  @@unique([userId, campaignId], name: "user_campaign")
  @@map("ab_test_sessions")
}

model AbTestImageStats {
  id            String        @id @default(dbgenerated("gen_random_uuid()"))
  sessionId     Int
  session       AbTestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  imageUrl      String
  imageIndex    Int           // 0-4 (which image in the array)
  targetViews   Int           // Usually 1000
  startedAt     DateTime      @default(now())
  completedAt   DateTime?
  viewsAtStart  BigInt        // Total campaign views when this image started
  viewsAtEnd    BigInt?       // Total campaign views when this image completed
  checkHistory  Json[]        @default([]) // Array of {timestamp, totalViews, viewsSinceStart}
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([sessionId])
  @@index([sessionId, imageIndex])
  @@map("ab_test_image_stats")
}

